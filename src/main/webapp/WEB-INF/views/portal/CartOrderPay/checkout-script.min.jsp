<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<% pageContext.setAttribute("APP_PATH", request.getContextPath()); %>
<script>function getProductOrderList(callback){$.ajax({url:"${APP_PATH}/MlfrontOrder/getNowOrderDetail",type:"get",async:!1,success:function(data){100==data.code&&callback&&callback(data.extend)}})}function getProvinceData(reqData,callback){$.ajax({url:"${APP_PATH}/MlfrontAddress/getAreafreightMoney",data:JSON.stringify(reqData),async:!1,type:"post",dataType:"json",contentType:"application/json",async:!1,success:function(data){100==data.code&&callback&&callback(data.extend)}})}function getUserInfo(callback){$.ajax({url:"${APP_PATH}/MlfrontAddress/getOneMlfrontAddressDetailByUinfo",type:"post",dataType:"json",async:!1,success:function(data){callback&&callback(data.extend)}})}function updateOrderNum(el,num,callback){var targetData=el.parents(".order-item").data("orderitem")||null,reqData={orderitemId:parseInt(targetData.orderitemId),orderitemPskuNumber:num};$.ajax({url:"${APP_PATH}/MlfrontOrder/updateOrderItemNum",data:JSON.stringify(reqData),type:"post",dataType:"json",contentType:"application/json",success:function(data){100==data.code?(updateProructNumberInCart(),targetData.orderitemPskuNumber=num,el.parents(".order-item").data("orderitem",targetData),callback&&callback(),updateProductNumSuccessModal()):(el.find(".product-num").val(targetData.orderitemPskuNumber),updateProductNumFailModal())},error:function(){el.find(".product-num").val(targetData.cartitemProductNumber),updateProductNumFailModal()}})}function deleteOrderProduct(el,callback){var targetData=el.data("orderitem")||null,orderitemId=parseInt(targetData.orderitemId),reqData={orderitemId:orderitemId};function resetOrderListData(){var itemIdArr=$(".order-list").data("itemidarr").split(",");itemIdArr=itemIdArr.filter((function(id){return id!=orderitemId})),$(".order-list").data("itemidarr",itemIdArr.join(","))}$.ajax({url:"${APP_PATH}/MlfrontOrder/delOrderItem",data:JSON.stringify(reqData),type:"post",dataType:"json",contentType:"application/json",success:function(data){el.remove(),$(".order-item").length||goToCartList(),callback&&callback(targetData.orderitemPid),resetOrderListData(),deleteProductSuccessModal()},error:function(){el.find(".product-num").val(targetData.cartitemProductNumber),deleteProductFailModal()}})}function orderSaveAddress(reqData,callback){$.ajax({url:"${APP_PATH}/MlfrontAddress/save",type:"post",dataType:"json",data:JSON.stringify(reqData),contentType:"application/json",success:function(data){100==data.code?callback&&callback(data.extend.mlfrontAddress):sysModalTip()},error:function(){sysModalTip()}})}function orderPay(reqData,callback){$.ajax({url:"${APP_PATH}/MlfrontOrder/orderToPayInfo",data:JSON.stringify(reqData),type:"post",dataType:"json",contentType:"application/json",success:function(data){100==data.code?callback&&callback(data.extend):sysModalTip()},error:function(err){sysModalTip()}})}function countryCombineWithProvince(){getProvinceData({addressCountry:$("#addressCountry").find("option:checked").data("value")},(function(data){var money=data.areafreightMoney,provinceList=data.mlPaypalStateprovinceList;$(".order-address-shipping").data("shipping",money).find(".value").text("$"+money),provinceList&&provinceList.length>0?(renderProvince(provinceList),$("#addressProvince").data("status",!1),hasProvince=!0,$("#addressProvince").parents(".form-group").show(),$("#addressCountry").parents(".form-group").css("width","50%")):($("#addressProvince").val("").data("status",!0),hasProvince=!1,$("#addressProvince").parents(".form-group").hide(),$("#addressCountry").parents(".form-group").css("width","100%"))}))}function getTime(){var date=new Date,year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate(),hours=date.getHours(),minutes=date.getMinutes(),seconds=date.getSeconds();return year+"-"+month+"-"+day+" "+hours+":"+minutes+":"+(seconds<10?"0"+seconds:seconds)}function calOrderList(){var couponData=$(".order-coupon-group").data("coupon"),resData={prototal:0,subtotal:0,shipping:$(".order-address-shipping").data("shipping")||0,coupon:0};if($(".order-item").each((function(idx,item){var $data=$(item).data("orderitem"),orderitemPrice=parseFloat((parseFloat(accuracyCal(($data.orderitemProductOriginalprice||0)+parseFloat($data.orderitemPskuMoneystr||0),$data.orderitemProductAccoff||100))*$data.orderitemPskuNumber).toFixed(2));couponData&&couponData.mlbackCouponOne&&couponData.mlbackCouponOne.couponProductonlyType&&couponData.mlbackCouponOne.couponProductonlyPidstr==$data.orderitemPid&&("0"==couponData.mlbackCouponOne.couponType?resData.coupon=couponData.mlbackCouponOne.couponPrice:resData.coupon=0),resData.prototal+=orderitemPrice})),couponData&&!couponData.mlbackCouponOne&&(resData.coupon=0,$(".order-coupon-tip").html("<p>Code invalid !</p>")),couponData&&couponData.mlbackCouponOne)if(couponData.mlbackCouponOne.couponProductonlyType){if("1"==couponData.mlbackCouponOne.couponType&&$(".order-coupon-tip").html("<p>Code invalid !</p>"),"0"==couponData.mlbackCouponOne.couponType){var productIdArr=$(".order-list").data("productidarr").split(","),singProductId=couponData.mlbackCouponOne.couponProductonlyPidstr;singProductId&&productIdArr.indexOf(singProductId)>-1?$(".order-coupon-tip").html('<p><i style="color: #f00">'+couponData.mlbackCouponOne.couponCode+"</i> used successful ! </p>"):$(".order-coupon-tip").html('<p><i style="color: #f00">'+couponData.mlbackCouponOne.couponCode+'</i> The coupon is invalid for the purchase of products, it is only applicable to specific products ! </p><p>eg: <a style="color: #333;" href="${APP_PATH}/'+couponData.mlbackCouponOne.couponProductseonamesstronlyPid+'.html">'+couponData.mlbackCouponOne.couponProductpronamesstronlyPid+"</a></p>")}}else"0"==couponData.mlbackCouponOne.couponType&&(couponData.mlbackCouponOne.couponPriceBaseline?resData.prototal>=parseFloat(couponData.mlbackCouponOne.couponPriceBaseline)?(resData.coupon=couponData.mlbackCouponOne.couponPrice,$(".order-coupon-tip").html('<p><i style="color: #f00">'+couponData.mlbackCouponOne.couponCode+"</i> used successful ! </p>")):(resData.coupon=0,$(".order-coupon-tip").html('<p>The minimum usage price of this coupon is + <i style="color: #f00">$'+couponData.mlbackCouponOne.couponPriceBaseline+"<i></p>")):(resData.coupon=couponData.mlbackCouponOne.couponPrice,$(".order-coupon-tip").html('<p><i style="color: #f00">'+couponData.mlbackCouponOne.couponCode+"</i> used successful ! </p>"))),"1"==couponData.mlbackCouponOne.couponType&&(couponData.mlbackCouponOne.couponPriceBaseline?resData.prototal>=parseFloat(couponData.mlbackCouponOne.couponPriceBaseline)?(resData.coupon=parseFloat(accuracyCal(resData.prototal,couponData.mlbackCouponOne.couponPriceoff)),$(".order-coupon-tip").html('<p><i style="color: #f00">'+couponData.mlbackCouponOne.couponCode+"</i> used successful ! </p>")):(resData.coupon=0,$(".order-coupon-tip").html('<p>The minimum usage price of this coupon is + <i style="color: #f00">$'+couponData.mlbackCouponOne.couponPriceBaseline+"<i></p>")):(resData.coupon=parseFloat(accuracyCal(resData.prototal,couponData.mlbackCouponOne.couponPriceoff)),$(".order-coupon-tip").html('<p><i style="color: #f00">'+couponData.mlbackCouponOne.couponCode+"</i> used successful ! </p>")));return resData.subtotal=resData.prototal+resData.shipping-resData.coupon,resData.coupon<=0&&$(".order-coupon-group").data("coupon",""),resData}function resetOrderCal(){var calOrder=calOrderList();$(".order-cal-prototal").text("$"+calOrder.prototal.toFixed(2)),$(".order-cal-shipping").text("$"+calOrder.shipping.toFixed(2)),$(".order-cal-coupon").text("-$"+calOrder.coupon.toFixed(2)),$(".order-cal-subtotal").text("$"+calOrder.subtotal.toFixed(2)).data("price",calOrder.subtotal.toFixed(2))}function renderCountry(){for(var htmlStr="",countryList=[{name:"United States",nickname:"US"},{name:"United Kingdom",nickname:"GB"},{name:"Canada",nickname:"CA"},{name:"Nigeria",nickname:"NG"},{name:"Australia",nickname:"AU"},{name:"South Africa",nickname:"ZA"},{name:"Germany",nickname:"DE"},{name:"Kenya",nickname:"KE"},{name:"Spain",nickname:"ES"},{name:"United Arab Emirates",nickname:"AE"},{name:"Afghanistan",nickname:"AF"},{name:"France",nickname:"FR"},{name:"Åland Islands",nickname:"AX"},{name:"Albania",nickname:"AL"},{name:"Algeria",nickname:"DZ"},{name:"American Samoa",nickname:"AS"},{name:"Andorra",nickname:"AD"},{name:"Angola",nickname:"AO"},{name:"Anguilla",nickname:"AI"},{name:"Antarctica",nickname:"AQ"},{name:"Antigua and Barbuda",nickname:"AG"},{name:"Argentina",nickname:"AR"},{name:"Armenia",nickname:"AM"},{name:"Aruba",nickname:"AW"},{name:"Austria",nickname:"AT"},{name:"Azerbaijan",nickname:"AZ"},{name:"Bahamas",nickname:"BS"},{name:"Bahrain",nickname:"BH"},{name:"Bangladesh",nickname:"BD"},{name:"Barbados",nickname:"BB"},{name:"Belarus",nickname:"BY"},{name:"Belgium",nickname:"BE"},{name:"Belize",nickname:"BZ"},{name:"Benin",nickname:"BJ"},{name:"Bermuda",nickname:"BM"},{name:"Bhutan",nickname:"BT"},{name:"Bolivia",nickname:"BO"},{name:"Bosnia and Herzegovina",nickname:"BA"},{name:"Botswana",nickname:"BW"},{name:"Bouvet Island",nickname:"BV"},{name:"Brazil",nickname:"BR"},{name:"British Indian Ocean Territory",nickname:"IO"},{name:"British Virgin Islands",nickname:"VG"},{name:"Brunei",nickname:"BN"},{name:"Bulgaria",nickname:"BG"},{name:"Burkina Faso",nickname:"BF"},{name:"Burundi",nickname:"BI"},{name:"Cambodia",nickname:"KH"},{name:"Cameroon",nickname:"CM"},{name:"Cape Verde",nickname:"CV"},{name:"Cayman Islands",nickname:"KY"},{name:"Central African Republic",nickname:"CF"},{name:"Chad",nickname:"TD"},{name:"Chile",nickname:"CL"},{name:"China",nickname:"CN"},{name:"Christmas Island",nickname:"CX"},{name:"Cocos (Keeling) Islands",nickname:"CC"},{name:"Colombia",nickname:"CO"},{name:"Comoros",nickname:"KM"},{name:"Congo - Brazzaville",nickname:"CG"},{name:"Congo - Kinshasa",nickname:"CD"},{name:"Cook Islands",nickname:"CK"},{name:"Costa Rica",nickname:"CR"},{name:"Côte d’Ivoire",nickname:"CI"},{name:"Croatia",nickname:"HR"},{name:"Cuba",nickname:"CU"},{name:"Cyprus",nickname:"CY"},{name:"Czech Republic",nickname:"CZ"},{name:"Denmark",nickname:"DK"},{name:"Djibouti",nickname:"DJ"},{name:"Dominica",nickname:"DM"},{name:"Dominican Republic",nickname:"DO"},{name:"Ecuador",nickname:"EC"},{name:"Egypt",nickname:"EG"},{name:"El Salvador",nickname:"SV"},{name:"Equatorial Guinea",nickname:"GQ"},{name:"Eritrea",nickname:"ER"},{name:"Estonia",nickname:"EE"},{name:"Ethiopia",nickname:"ET"},{name:"Falkland Islands",nickname:"FK"},{name:"Faroe Islands",nickname:"FO"},{name:"Fiji",nickname:"FJ"},{name:"Finland",nickname:"FI"},{name:"French Guiana",nickname:"GF"},{name:"French Polynesia",nickname:"PF"},{name:"French Southern Territories",nickname:"TF"},{name:"Gabon",nickname:"GA"},{name:"Gambia",nickname:"GM"},{name:"Georgia",nickname:"GE"},{name:"Ghana",nickname:"GH"},{name:"Gibraltar",nickname:"GI"},{name:"Greece",nickname:"GR"},{name:"Greenland",nickname:"GL"},{name:"Grenada",nickname:"GD"},{name:"Guadeloupe",nickname:"GP"},{name:"Guam",nickname:"GU"},{name:"Guatemala",nickname:"GT"},{name:"Guernsey",nickname:"GG"},{name:"Guinea",nickname:"GN"},{name:"Guinea-Bissau",nickname:"GW"},{name:"Guyana",nickname:"GY"},{name:"Haiti",nickname:"HT"},{name:"Heard &amp; McDonald Islands",nickname:"HM"},{name:"Honduras",nickname:"HN"},{name:"Hong Kong SAR China",nickname:"HK"},{name:"Hungary",nickname:"HU"},{name:"Iceland",nickname:"IS"},{name:"India",nickname:"IN"},{name:"Indonesia",nickname:"ID"},{name:"Iran",nickname:"IR"},{name:"Iraq",nickname:"IQ"},{name:"Ireland",nickname:"IE"},{name:"Isle of Man",nickname:"IM"},{name:"Israel",nickname:"IL"},{name:"Italy",nickname:"IT"},{name:"Jamaica",nickname:"JM"},{name:"Japan",nickname:"JP"},{name:"Jersey",nickname:"JE"},{name:"Jordan",nickname:"JO"},{name:"Kazakhstan",nickname:"KZ"},{name:"Kiribati",nickname:"KI"},{name:"Kuwait",nickname:"KW"},{name:"Kyrgyzstan",nickname:"KG"},{name:"Laos",nickname:"LA"},{name:"Latvia",nickname:"LV"},{name:"Lebanon",nickname:"LB"},{name:"Lesotho",nickname:"LS"},{name:"Liberia",nickname:"LR"},{name:"Libya",nickname:"LY"},{name:"Liechtenstein",nickname:"LI"},{name:"Lithuania",nickname:"LT"},{name:"Luxembourg",nickname:"LU"},{name:"Macau SAR China",nickname:"MO"},{name:"Macedonia",nickname:"MK"},{name:"Madagascar",nickname:"MG"},{name:"Malawi",nickname:"MW"},{name:"Malaysia",nickname:"MY"},{name:"Maldives",nickname:"MV"},{name:"Mali",nickname:"ML"},{name:"Malta",nickname:"MT"},{name:"Marshall Islands",nickname:"MH"},{name:"Martinique",nickname:"MQ"},{name:"Mauritania",nickname:"MR"},{name:"Mauritius",nickname:"MU"},{name:"Mayotte",nickname:"YT"},{name:"Mexico",nickname:"MX"},{name:"Micronesia",nickname:"FM"},{name:"Moldova",nickname:"MD"},{name:"Monaco",nickname:"MC"},{name:"Mongolia",nickname:"MN"},{name:"Montenegro",nickname:"ME"},{name:"Montserrat",nickname:"MS"},{name:"Morocco",nickname:"MA"},{name:"Mozambique",nickname:"MZ"},{name:"Myanmar (Burma)",nickname:"MM"},{name:"Namibia",nickname:"NA"},{name:"Nauru",nickname:"NR"},{name:"Nepal",nickname:"NP"},{name:"Netherlands",nickname:"NL"},{name:"Netherlands Antilles",nickname:"AN"},{name:"New Caledonia",nickname:"NC"},{name:"New Zealand",nickname:"NZ"},{name:"Nicaragua",nickname:"NI"},{name:"Niger",nickname:"NE"},{name:"Niue",nickname:"NU"},{name:"Norfolk Island",nickname:"NF"},{name:"Northern Mariana Islands",nickname:"MP"},{name:"North Korea",nickname:"KP"},{name:"Norway",nickname:"NO"},{name:"Oman",nickname:"OM"},{name:"Pakistan",nickname:"PK"},{name:"Palau",nickname:"PW"},{name:"Palestinian Territories",nickname:"PS"},{name:"Panama",nickname:"PA"},{name:"Papua New Guinea",nickname:"PG"},{name:"Paraguay",nickname:"PY"},{name:"Peru",nickname:"PE"},{name:"Philippines",nickname:"PH"},{name:"Pitcairn Islands",nickname:"PN"},{name:"Poland",nickname:"PL"},{name:"Portugal",nickname:"PT"},{name:"Puerto Rico",nickname:"PR"},{name:"Qatar",nickname:"QA"},{name:"Réunion",nickname:"RE"},{name:"Romania",nickname:"RO"},{name:"Russia",nickname:"RU"},{name:"Rwanda",nickname:"RW"},{name:"Saint Barthélemy",nickname:"BL"},{name:"Saint Helena",nickname:"SH"},{name:"Saint Kitts and Nevis",nickname:"KN"},{name:"Saint Lucia",nickname:"LC"},{name:"Saint Martin",nickname:"MF"},{name:"Saint Pierre and Miquelon",nickname:"PM"},{name:"Samoa",nickname:"WS"},{name:"San Marino",nickname:"SM"},{name:"São Tomé and Príncipe",nickname:"ST"},{name:"Saudi Arabia",nickname:"SA"},{name:"Senegal",nickname:"SN"},{name:"Serbia",nickname:"RS"},{name:"Seychelles",nickname:"SC"},{name:"Sierra Leone",nickname:"SL"},{name:"Singapore",nickname:"SG"},{name:"Slovakia",nickname:"SK"},{name:"Slovenia",nickname:"SI"},{name:"Solomon Islands",nickname:"SB"},{name:"Somalia",nickname:"SO"},{name:"South Georgia &amp; South Sandwich Islands",nickname:"GS"},{name:"South Korea",nickname:"KR"},{name:"Sri Lanka",nickname:"LK"},{name:"St. Vincent &amp; Grenadines",nickname:"VC"},{name:"Sudan",nickname:"SD"},{name:"Suriname",nickname:"SR"},{name:"Svalbard and Jan Mayen",nickname:"SJ"},{name:"Swaziland",nickname:"SZ"},{name:"Sweden",nickname:"SE"},{name:"Switzerland",nickname:"CH"},{name:"Syria",nickname:"SY"},{name:"Taiwan",nickname:"TW"},{name:"Tajikistan",nickname:"TJ"},{name:"Tanzania",nickname:"TZ"},{name:"Thailand",nickname:"TH"},{name:"Timor-Leste",nickname:"TL"},{name:"Togo",nickname:"TG"},{name:"Tokelau",nickname:"TK"},{name:"Tonga",nickname:"TO"},{name:"Trinidad and Tobago",nickname:"TT"},{name:"Tunisia",nickname:"TN"},{name:"Turkey",nickname:"TR"},{name:"Turkmenistan",nickname:"TM"},{name:"Turks and Caicos Islands",nickname:"TC"},{name:"Tuvalu",nickname:"TV"},{name:"Uganda",nickname:"UG"},{name:"Ukraine",nickname:"UA"},{name:"Uruguay",nickname:"UY"},{name:"U.S. Outlying Islands",nickname:"UM"},{name:"U.S. Virgin Islands",nickname:"VI"},{name:"Uzbekistan",nickname:"UZ"},{name:"Vanuatu",nickname:"VU"},{name:"Vatican City",nickname:"VA"},{name:"Venezuela",nickname:"VE"},{name:"Vietnam",nickname:"VN"},{name:"Wallis and Futuna",nickname:"WF"},{name:"Western Sahara",nickname:"EH"},{name:"Yemen",nickname:"YE"},{name:"Zambia",nickname:"ZM"},{name:"Zimbabwe",nickname:"ZW"}],i=0,len=countryList.length;i<len;i++)htmlStr+='<option data-value="'+countryList[i].nickname+'" value="'+countryList[i].name+'">'+countryList[i].name+"</option>";$("#addressCountry").html(htmlStr)}function renderProvince(data){for(var htmlStr='<option value="state">State</option>',defaultValue=$("#addressProvince").data("value"),i=0,len=data.length;i<len;i+=1)htmlStr+='<option value="'+data[i].stateprovinceName+'"'+(defaultValue==data[i].stateprovinceName?"selected":"")+">"+data[i].stateprovinceName+"</option>";$("#addressProvince").html(htmlStr)}function renderOrderList(data){var $orderList=$('<div class="order-list" />'),orderProductIdArr=[],orderItemIdArr=[],orderProductNumArr=[];data.forEach((function(item,idx){var orderSkuList="",optionArr=item.orderitemPskuIdnamestr.split(","),skuNameArr=item.orderitemPskuName.split(",");optionArr.forEach((function(item,idx){orderSkuList+='<div class="order-sku-list-item"><span class="name">'+item+' :</span><span class="value">'+skuNameArr[idx]+"</span></div>"})),orderProductIdArr.push(item.orderitemPid),orderItemIdArr.push(item.orderitemId),orderProductNumArr.push(item.orderitemPskuNumber);var productLink=item.orderitemPseo?"${APP_PATH}/"+item.orderitemPseo+".html":"javascript:;";$orderList.append($('<div class="order-item"><a href="'+productLink+'" class="order-img lazyload" data-src="'+item.orderitemProductMainimgurl+'"></a><div class="order-product"><a class="order-product-name" href="'+productLink+'">'+item.orderitemPname+'</a><div class="order-sku-list">'+orderSkuList+'</div><div class="order-product-num"><div class="order-product-price"><span class="product-define-price">$'+(item.orderitemProductOriginalprice+parseFloat(item.orderitemPskuMoneystr)||0).toFixed(2)+'</span><span class="product-now-price">$'+(item.orderitemProductOriginalprice&&item.orderitemProductAccoff?accuracyCal(item.orderitemProductOriginalprice+parseFloat(item.orderitemPskuMoneystr),item.orderitemProductAccoff):0)+'</span></div><span class="icon delete product-delete"></span><div class="product-qty"><span class="group-addon product-sub"><i class="icon sub"></i></span><input type="text" disabled class="product-num" value="'+item.orderitemPskuNumber+'" /><span class="group-addon product-add"><i class="icon plus"></i></span></div></div></div></div>').data("orderitem",item))})),$orderList.data("itemidarr",orderItemIdArr.join(",")).data("productidarr",orderProductIdArr.join(",")).data("itemnumarr",orderProductNumArr.join(","));var $cartReviewBox=$('<div class="cart-box"><div class="cart-box-title"><span class="order-sort">2</span>Checkout Review</div><div class="cart-box-body"><div class="cart-box-time">'+getTime()+"</div></div></div>");$cartReviewBox.find(".cart-box-body").append($orderList),$("main .order-left").append($cartReviewBox),new LazyLoad($orderList.find(".lazyload"),{root:null,rootMargin:"10px",threshold:0})}function renderOrderCoupons(){var $cartCouponBox=$('<div class="cart-box"><div class="cart-box-title"><span class="order-sort">3</span>DISCOUNT CODES</div><div class="cart-box-body"><div class="product-coupons hide"></div><div class="order-coupons"><div class="order-coupon-list"></div><div class="order-coupon-group"><input type="text" placeholder="Please enter code" /><button id="order-check-coupon" class="btn btn-gray">check it</button></div><div class="order-coupon-tip"></div></div></div></div>');$("main .order-right").append($cartCouponBox),getCouponAreaData(renderCouponAreaData)}function renderOrderPaymentMethod(){var $cartPaymentBox=$('<div class="cart-box"><div class="cart-box-title"><span class="order-sort">4</span>PAYMENT METHOD</div><div class="cart-box-body"><div class="order-payment" data-pay="0"><div class="order-payment-item custom-check"><input type="radio" name="payment" id="payment-paypal" checked value="0"><label for="payment-paypal"><img src="${APP_PATH}/static/pc/img/paypal-1.png"><span>Pay with PayPal account</span></label></div><div class="paypal-box"><img src="${APP_PATH}/static/pc/img/paypal-3.svg"><div class="paypal-des">After clicking “Complete order”, you will be redirected to PayPal to complete your purchase securely.</div></div><div class="order-payment-item custom-check"><input type="radio" name="payment" id="payment-paypalcard" value="1"><label for="payment-paypalcard"><b style="margin-right: .2rem;">Credit card</b><img src="${APP_PATH}/static/pc/img/paypal-2.png"></label></div><div class="card-element-box mask hide"><div class="spinner"></div><div id="card-element"></div><p id="card-error" role="alert"></p></div></div></div></div>');$("main .order-right").append($cartPaymentBox)}function renderOrderBuyerMsg(){var $cartBuyerMsgBox=$('<div class="cart-box"><div class="cart-box-title"><span class="order-sort">5</span>ADDITIONAL INFORMATION</div><div class="cart-box-body"><div class="order-buyer-msg"><textarea rows="4" placeholder="Any Request,Notes Here."></textarea></div></div></div>');$("main .order-right").append($cartBuyerMsgBox)}function rednerOrderCal(){var calOrder=calOrderList(),$cartCalBox=$('<div class="cart-box"><div class="cart-box-body"><div class="order-cal"><div class="order-cal-item"><span class="name">prototal</span><span class="value order-cal-prototal">$'+calOrder.prototal.toFixed(2)+'</span></div><div class="order-cal-item"><span class="name">coupon</span><span class="value order-cal-coupon">-$'+calOrder.coupon.toFixed(2)+'</span></div><div class="order-cal-item"><span class="name">shipping</span><span class="value order-cal-shipping">$'+calOrder.shipping.toFixed(2)+'</span></div><div class="order-cal-item"><span class="name">subtotal</span><span class="value order-cal-subtotal" data-price="'+calOrder.subtotal.toFixed(2)+'">$'+calOrder.subtotal.toFixed(2)+'</span></div><div class="order-cal-btn"><a href="javascript:;" id="pay-now" class="btn btn-pink">Complete Order</a><button id="payment-form" class="btn btn-pink hide" disabled><div class="spinner hide"></div><span class="btn-text">Pay Securely Now</span></button></div></div></div></div>');$("main .order-right").append($cartCalBox)}function checkInputAdressInfo(){for(var flag=!0,idx=0,len=$(".address-box .form-group").length;idx<len;idx+=1){var item=$(".address-box .form-group")[idx];if(!$(item).find(".form-control").data("status")&&(!$(item).find(".form-control").val()||"state"==$(item).find(".form-control").val())){mlModalTip('Address information <i style="color: #f00">'+$(item).find(".form-label").text()+"</i> can't be empty !"),$(item).find(".form-control").focus(),flag=!1;break}}return flag}function checkCouponCode(reqData,callback){$.ajax({url:"${APP_PATH}/MlbackCoupon/getOneMlbackCouponDetailByCode",data:JSON.stringify(reqData),type:"post",dataType:"json",contentType:"application/json",success:function(data){100==data.code?callback&&callback(data.extend):sysModalTip()},error:function(err){sysModalTip()}})}function getOrderAddress(){var addressData={};return $(".address-box .form-control").each((function(idx,item){"addressCountry"==item.name&&(addressData.addressCountryCode=$(item).find("option:checked").data("value")),addressData[item.name]=(item.value||"").trim()})),addressData}function initOrderAddress(data){$(".address-box .form-control").each((function(idx,item){"addressProvince"==item.name&&$(item).data("value",data[item.name]),$(item).val(data[item.name])}))}function getOrderPayInfo(){var couponData=$(".order-coupon-group").data("coupon")||{};return{orderId:$(".order-list").data("orderid")||null,orderOrderitemidstr:$(".order-list").data("itemidarr"),orderCouponId:couponData.mlbackCouponOne&&couponData.mlbackCouponOne.couponId||"",orderCouponCode:couponData.mlbackCouponOne&&couponData.mlbackCouponOne.couponCode||"",orderPayPlate:$('input[name="payment"]:checked').val(),orderProNumStr:$(".order-list").data("itemnumarr"),orderBuyMess:$(".order-buyer-msg textarea").val(),addressinfoId:$("#addressId").val()}}function initialOrder(){renderCountry();var $paypalTip=$(".paypal-error-tip");!$paypalTip.hasClass("hide")&&$paypalTip.addClass("hide"),$("#addressEmail, #addressCountry, #addressProvince, #addressCity, #addressPost").on("foucs",(function(){!$paypalTip.hasClass("hide")&&$paypalTip.addClass("hide")})),getUserInfo((function(data){var addressData=data.mlfrontAddressOne;addressData&&initOrderAddress(addressData),$(".order-address-shipping").data("shipping",data.areafreightMoney).find(".value","$"+data.areafreightMoney),countryCombineWithProvince()})),getProductOrderList((function(data){var orderListData=data.mlfrontOrderItemList;if(!orderListData.length)return mlModalTip("Don't have to pay for goods, please to add items in the shopping cart, and then to pay !"),void goToCartList();renderOrderList(orderListData),$(".order-list").data("orderid",data.orderId)})),renderOrderCoupons(),renderOrderPaymentMethod(),renderOrderBuyerMsg(),rednerOrderCal()}var hasProvince=!0;setTimeout(initialOrder,0),$("#addressCountry").on("change",(function(){countryCombineWithProvince(),resetOrderCal()})),$(document.body).on("click",".product-add",(function(){productAdd($(this),(function(el,num){updateOrderNum(el,num,resetOrderCal)}))})),$(document.body).on("click",".product-sub",(function(){productSub($(this),(function(el,num){updateOrderNum(el,num,resetOrderCal)}))})),$(document.body).on("click",".product-delete",(function(){deleteOrderProduct($(this).parents(".order-item"),(function(id){var productIdArr=$(".order-list").data("productidarr").split(",");productIdArr=productIdArr.filter((function(item){return item!=id})),$(".order-list").data("productidarr",productIdArr.join(",")),resetOrderCal()}))})),$(document.body).on("click","#order-check-coupon",(function(){var couponCode=$(".order-coupon-group input").val().trim();couponCode?checkCouponCode({couponCreatetime:$(".order-list").data("productidarr"),couponCode:couponCode},(function(data){$(".order-coupon-group").data("coupon",data),resetOrderCal()})):mlModalTip("Please enter a valid coupon code !")})),$(document.body).on("click","#pay-now",(function(){checkInputAdressInfo()&&orderSaveAddress(getOrderAddress(),(function(data){$("#addressId").val(data.addressId);var productIdArr=$(".order-list").data("productidarr")?$(".order-list").data("productidarr").split(","):[],orderMoney=$(".order-cal-subtotal").data("price");fbq("track","AddPaymentInfo",{content_ids:productIdArr,content_type:"product",value:orderMoney,currency:"USD"}),payLoading(),orderPay(getOrderPayInfo(),goToPay)}))}));</script>
<script>
	function addStripeScript() {
		var script = document.createElement('script');
		script.src = 'https://js.stripe.com/v3/';
		document.body.appendChild(script);
		script.onload = function() {
			stripePayment();
		}
	}
	function stripePayment() {
  		function payWithCard(stripe, card, clientSecret) {
  			stripe
  				.confirmCardPayment(clientSecret, {
	  				payment_method: {
	  					card: card,
	  					billing_details: {
	  						name: (addressData.addressUserfirstname + ' ' + addressData.addressUserlastname),
							phone: addressData.addressTelephone,
							email: addressData.addressEmail,
	  						address: {
	  							country: addressData.addressCountryCode,
	  						    state: addressData.addressProvince,
	  						    city: addressData.addressCity,
	  						    postal_code: addressData.addressPost,
	  							line1: addressData.addressDetail,
	  						}
	  					}
	  				},
  					shipping: {
  						name: (addressData.addressUserfirstname + ' ' + addressData.addressUserlastname),
						phone: addressData.addressTelephone,
  						address: {
  						    country: addressData.addressCountry,
  						    state: addressData.addressProvince,
  						    city: addressData.addressCity,
  						    postal_code: addressData.addressPost,
  							line1: addressData.addressDetail,
  						}
  					}
  				})
  				.then(function(result) {
	  				if (result.error) {
	  					// Show error to your customer
	  					paymentError(result.error.message);
	  				} else {
	  					// The payment succeeded!
	  					paymentSuccess(result.paymentIntent);
	  				}
	  			});
  		}
  		
  		function backSendCardInfo(data) {
  			var formData = new FormData();
  			$('#card-error').text(data.status);

  			formData.append('payinfoId', data.description.split(',')[0].replace('VIP', ''));
			formData.append('CardID', data.payment_method);
			formData.append('PayUname', (addressData.addressUserfirstname + ' ' + addressData.addressUserlastname));

			$.ajax({
				url: "${APP_PATH}/stripe/cardSuccessInfo",
				type: "post",
				data: formData,
				processData: false,
				contentType: false,
				cache: false,
				dataType: 'json',
				success: function (data) {
					if (data.code == 100 && data.extend.updateStatus) {
						window.location.href= '${APP_PATH}/success.html';						
					} else {
						$('#card-error').text('The payment is successful, but the shopping list cannot be generated, please contact customer service for help');
					}
				},
				error: function() {
					$('#card-error').text('The payment is successful, but the shopping list cannot be generated, please contact customer service for help');
				}
			});
  		}

  		function paymentSuccess(data) {
  			// fb ad
			var productIdArr = $('.order-list').data('productidarr') ? $('.order-list').data('productidarr').split(',') : [];
			var orderMoney = $('.order-cal-subtotal').data('price');

			fbq('track', 'AddPaymentInfo', {
				content_ids: productIdArr,
				content_type: 'product',
				value: orderMoney,
				currency: 'USD'
			});
			// send card info
  			backSendCardInfo(data);
  		}

  		function paymentError(errorMsgText) {
  			paymentLoading(false);
  			var errorMsg = $('#card-error');
  			errorMsg.text(errorMsgText);
  			setTimeout(function() {
  				errorMsg.text('');
  			}, 4000);
  		}

  		// Show a spinner on payment submission
  		function paymentLoading(isLoading) {
  			if (isLoading) {
  				// Disable the button and show a spinner
  				$('#payment-form').get(0).disabled = true;
  				$('#payment-form .spinner').removeClass('hide');
  				$('#payment-form .btn-text').addClass('hide');
  			} else {
  				$('#payment-form').get(0).disabled = false;
  				$('#payment-form .spinner').addClass('hide');
  				$('#payment-form .btn-text').removeClass('hide');
  			}
  		}
  		
  		// create one payment
  		function createPayment(reqData, stripe, card) {
  			orderPay(reqData, function(data) {
  				$.ajax({
  	  				url: '${APP_PATH}/stripe/create-payment-intent',
  	  				data: JSON.stringify({
  	  					'payinfoid': data.payinfoId,
  	  					'payinfoOid': data.orderId
  	  				}),
  	  				type: 'post',
  	  				dataType: 'json',
  	  				contentType: 'application/json',
  	  				success: function (data) {
  	  					if (data.code == 100) {
  	  						var stripeData = JSON.parse(data.extend.intentKey);
<<<<<<< HEAD
  	  						payWithCard(stripe, card, stripeData.clientSecret);
=======
  	  						payWithCard(stripe, card, stripeData.clientSecret);  	  						
>>>>>>> cceb54af182d8b9a86e4bf6d7018f43522bb06a5
  	  					} else {
  	  						sysModalTip();
  	  					}
  	  				},
  	  				error: function () {
  	  					sysModalTip();
  	  				}
  	  		    });
  			});
  		}
  		var style = {
  			base: {
  				color: '#32325d',
  				fontFamily: 'Arial, sans-serif',
  				fontSmoothing: 'antialiased',
  				fontSize: '16px',
  				'::placeholder': { }
  			},
  			invalid: {
  				fontFamily: 'Arial, sans-serif',
  				color: '#fa755a',
  			}
  		};
  		var stripe = null;
  		var card = null;
  		var elements = null;

  		stripe = Stripe(ml.stripe_key);
  		elements = stripe.elements();
  		card = elements.create('card', { style: style });
  		// Stripe injects an iframe into the DOM
  		card.mount('#card-element');
  		card.on('ready', function (event) {
  			hasStripe = true;
  			$('.card-element-box').removeClass('mask');
  			paymentLoading(false);
  		});
  		card.on('change', function (event) {
  			// Disable the Pay button if there are no card details in the Element
  			$('#payment-form').get(0).disabled = event.empty;
  			$('#card-error').text(event.error ? event.error.message : '');
  		});

  		$('#payment-form').on('click', function(event) {
  		    event.preventDefault();
  		    paymentLoading(true);
  		    // Complete payment when the submit button is clicked
  		    if (checkInputAdressInfo()) {
  		    	addressData = getOrderAddress();
				orderSaveAddress(addressData, function(data) {
					$('#addressId').val(data.addressId);

					createPayment(getOrderPayInfo(), stripe, card, data.clientSecret);
				});
  		    } else {
  		    	paymentLoading(false);
  		    }
  		});
  	}

	var hasStripe = false;
	var addressData = null;
	// tab pay
	$(document.body).on('change', 'input[type="radio"][name="payment"]', function() {
		var payType = $('input[name="payment"]:checked').val();
		if (payType == '0') {
			$('.paypal-box').removeClass('hide');
			$('.card-element-box').addClass('hide');
			$('#pay-now').removeClass('hide');
			$('#payment-form').addClass('hide');
		}

		if (payType == '1') {
			!hasStripe && addStripeScript();;
			$('.paypal-box').addClass('hide');
			$('.card-element-box').removeClass('hide');
			$('#pay-now').addClass('hide');
			$('#payment-form').removeClass('hide');
		}
	});
</script>